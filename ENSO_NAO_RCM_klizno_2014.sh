#Editiram period od 1.FEB.1961 (ne 1.JAN.1961)

 GODINE[1]=1998                            #ENSO ++,   NAO 0
GODINEm[1]=1997                            #ENSO ++,   NAO 0
 GODINE[2]=1988                            #ENSO + ,   NAO 0
GODINEm[2]=1987                            #ENSO + ,   NAO 0
 GODINE[3]=${GODINE[1]},${GODINE[2]}       #ENSO ++/+, NAO 0
GODINEm[3]=${GODINEm[1]},${GODINEm[2]}     #ENSO ++/+, NAO 0
     GODINE[4]=1967,1968,1984,1986         #ENSO - ,   NAO 0
    GODINEm[4]=1966,1967,1983,1985         #ENSO - ,   NAO 0
     GODINE[5]=1971,1974,1999              #ENSO --,   NAO 0
    GODINEm[5]=1970,1973,1998              #ENSO --,   NAO 0
     GODINE[6]=${GODINE[4]},${GODINE[5]}   #ENSO --/-, NAO 0
    GODINEm[6]=${GODINEm[4]},${GODINEm[5]} #ENSO --/-, NAO 0

 GODINE[7]=1973,1983,1992,1998,1987,1966                     #ENSO ++,   NAO all
GODINEm[7]=1972,1982,1991,1997,1986,1965                     #ENSO ++,   NAO all
 GODINE[8]=1995,1988,1977,1969                               #ENSO + ,   NAO all
GODINEm[8]=1994,1987,1976,1968                               #ENSO + ,   NAO all
 GODINE[9]=${GODINE[7]},${GODINE[8]}                         #ENSO ++/+, NAO all
GODINEm[9]=${GODINEm[7]},${GODINEm[8]}                       #ENSO ++/+, NAO all
     GODINE[10]=1967,1968,1984,1986,1985,1996                #ENSO - ,   NAO all
    GODINEm[10]=1966,1967,1983,1985,1984,1995                #ENSO - ,   NAO all
     GODINE[11]=1989,1976,2000,1971,1974,1999                #ENSO --,   NAO all
    GODINEm[11]=1988,1975,1999,1970,1973,1998                #ENSO --,   NAO all
     GODINE[12]=${GODINE[10]},${GODINE[11]}   		     #ENSO --/-, NAO all
    GODINEm[12]=${GODINEm[10]},${GODINEm[11]}                #ENSO --/-, NAO all

 GODINE[13]=1990,1993                         #ENSO 0,   NAO ++
GODINEm[13]=1989,1992                         #ENSO 0,   NAO ++
 GODINE[14]=1994,1997                         #ENSO 0,   NAO +
GODINEm[14]=1993,1996                         #ENSO 0,   NAO +
 GODINE[15]=${GODINE[13]},${GODINE[14]}       #ENSO 0,   NAO ++/+
GODINEm[15]=${GODINEm[13]},${GODINEm[14]}     #ENSO 0,   NAO ++/+
     GODINE[16]=1964,1965,1970,1979,1980      #ENSO 0,   NAO -
    GODINEm[16]=1963,1964,1969,1978,1979      #ENSO 0,   NAO -
     GODINE[17]=1963                          #ENSO 0,   NAO --
    GODINEm[17]=1962                          #ENSO 0,   NAO --
     GODINE[18]=${GODINE[16]},${GODINE[17]}   #ENSO 0,   NAO --/-
    GODINEm[18]=${GODINEm[16]},${GODINEm[17]} #ENSO 0,   NAO --/-

 GODINE[19]=1989,1990,1993,1995                              #ENSO all,   NAO ++
GODINEm[19]=1988,1989,1992,1994                              #ENSO all,   NAO ++
 GODINE[20]=1976,2000,1994,1997,1973,1983,1992               #ENSO all,   NAO +
GODINEm[20]=1975,1999,1993,1996,1972,1982,1991               #ENSO all,   NAO +
 GODINE[21]=${GODINE[19]},${GODINE[20]}                      #ENSO all,   NAO ++/+
GODINEm[21]=${GODINEm[19]},${GODINEm[20]}                    #ENSO all,   NAO ++/+
     GODINE[22]=1985,1996,1964,1965,1970,1979,1980,1977,1987 #ENSO all,   NAO -
    GODINEm[22]=1984,1995,1963,1964,1969,1978,1979,1976,1986 #ENSO all,   NAO -
     GODINE[23]=1963,1969,1966                               #ENSO all,   NAO --
    GODINEm[23]=1962,1968,1965                               #ENSO all,   NAO --
     GODINE[24]=${GODINE[22]},${GODINE[23]}                  #ENSO all,   NAO --/-
    GODINEm[24]=${GODINEm[22]},${GODINEm[23]}                #ENSO all,   NAO --/-



 GODINE[25]=1973,1983,1992,1987,1966                     #ENSO ++,   NAO nonzero (no 1998)
GODINEm[25]=1972,1982,1991,1986,1965                     #ENSO ++,   NAO nonzero (no 1997)
 GODINE[26]=1995,1977,1969                               #ENSO + ,   NAO nonzero (no 1988)
GODINEm[26]=1994,1976,1968                               #ENSO + ,   NAO nonzero (no 1987)
 GODINE[27]=${GODINE[25]},${GODINE[26]}                  #ENSO ++/+, NAO nonzero 
GODINEm[27]=${GODINEm[25]},${GODINEm[26]}                #ENSO ++/+, NAO nonzero
     GODINE[28]=1985,1996                                #ENSO - ,   NAO nonzero (no 1967, 1968, 1984, 1986)
    GODINEm[28]=1984,1995                                #ENSO - ,   NAO nonzero (no 1966, 1967, 1983, 1985)
     GODINE[29]=1989,1976,2000                           #ENSO --,   NAO nonzero (no 1971, 1974, 1999)
    GODINEm[29]=1988,1975,1999                           #ENSO --,   NAO nonzero (no 1970, 1973, 1998)
     GODINE[30]=${GODINE[28]},${GODINE[29]}   		 #ENSO --/-, NAO nonzero
    GODINEm[30]=${GODINEm[28]},${GODINEm[29]}            #ENSO --/-, NAO nonzero

 GODINE[31]=1989,1995                                    #ENSO nonzero (no 1990,1993) ,   NAO ++
GODINEm[31]=1988,1994                                    #ENSO nonzero (no 1989,1992) ,   NAO ++
 GODINE[32]=1976,2000,1973,1983,1992                     #ENSO nonzero (no 1994,1997) ,   NAO +
GODINEm[32]=1975,1999,1972,1982,1991                     #ENSO nonzero (no 1993,1996) ,   NAO +
 GODINE[33]=${GODINE[31]},${GODINE[32]}                  #ENSO nonzero,   NAO ++/+
GODINEm[33]=${GODINEm[31]},${GODINEm[32]}                #ENSO nonzero,   NAO ++/+
     GODINE[34]=1985,1996,1977,1987                      #ENSO nonzero ( no 1964, 1965, 1970, 1979, 1980),   NAO -
    GODINEm[34]=1984,1995,1976,1986                      #ENSO nonzero ( no 1963, 1964, 1969, 1978, 1979),   NAO -
     GODINE[35]=1969,1966                                #ENSO nonzero ( no 1963),   NAO --
    GODINEm[35]=1968,1965                                #ENSO nonzero ( no 1962),   NAO --
     GODINE[36]=${GODINE[34]},${GODINE[35]}              #ENSO nonzero,   NAO --/-
    GODINEm[36]=${GODINEm[34]},${GODINEm[35]}            #ENSO nonzero,   NAO --/-

#>>>> 2014 09 26 for VAR in pr          ; do
#>>>> 2014 11 21 for VAR in zg500 zg300 ; do
for VAR in pr                           ; do

#-----------------------
#-----------------------Ulazne datoteke
#-----------------------

    FILE[ 1]=ICTP-REGCM3_CTL_ERA40_MM_25km-CRU_1961-2000_${VAR}.nc
    FILE[ 2]=KNMI-RACMO2_CTL_ERA40_MM_25km-CRU_${VAR}.nc
    FILE[ 3]=C4IRCA3_CTL_ERA40_MM_25km-CRU_1961-2000_${VAR}.nc
    FILE[ 4]=MPI-M-REMO_CTL_ERA40_MM_25km-CRU_1961-2000_${VAR}.nc
    FILE[ 5]=ETHZ-CLM_CTL_ERA40_CRU_MM_25km_${VAR}.nc
    FILE[ 6]=METNOHIRHAM_CTR_ERA40_CRU_MM_25km_1961-2000_${VAR}.nc
    FILE[ 7]=SMHIRCA_CTL_ERA40_MM_25km-CRU_${VAR}.nc
    FILE[ 8]=CNRM-RM4.5_CTL_ERA40_MM_25km-CRU_${VAR}.nc
    FILE[ 9]=METO-HC_HadRM3Q0_CTL_ERA40_MM_25km-CRU_${VAR}.nc
    FILE[10]=HadRM3Q3_CTL_ERA40_CRU_MM_25km_${VAR}.nc
    FILE[11]=HadRM3Q16_CTL_ERA40_CRU_MM_25km_${VAR}.nc
    FILE[12]=OURANOSMRCC4.2.3_CTL_ERA40_MM_25km-CRUremap_1959-2000_${VAR}.nc
    FILE[13]=UCLM-PROMES_CTL_ERA40_CRU_MM_25km_${VAR}.nc
    FILE[14]=DMI-HIRHAM5_CTL_ERA40_MM_25km-CRU_${VAR}.nc
    FILE[15]=CHMIALADIN_CY28_ERA40_MM_25km-CRU_1961-2000_${VAR}.nc
    if [ ${VAR} == pr    ]; then
    NMODS=15 
    fi
    if [ ${VAR} == zg500 ]; then
    NMODS=14  
    FILE[13]=UCLM-PROMES_CTL_ERA40_MM_25km-CRUremap_${VAR}.nc
    fi
    if [ ${VAR} == zg300 ]; then
    NMODS=14   
    FILE[13]=UCLM-PROMES_CTL_ERA40_MM_25km-CRUremap_${VAR}.nc
    fi

        SEAStxt[ 1]="FMA"
        SEAStxt[ 2]="MAM"
        SEAStxt[ 3]="AMJ"
        SEAStxt[ 4]="MJJ"
        SEAStxt[ 5]="JJA"
        SEAStxt[ 6]="JAS"
        SEAStxt[ 7]="ASO"
        SEAStxt[ 8]="SON"
        SEAStxt[ 9]="OND"
        SEAStxt[10]="NDJ"
        SEAStxt[11]="DJF"
        SEAStxt[12]="JFM"

        SETmontxt[ 1]=03
        SETmontxt[ 2]=04
        SETmontxt[ 3]=05
        SETmontxt[ 4]=06
        SETmontxt[ 5]=07
        SETmontxt[ 6]=08
        SETmontxt[ 7]=09
        SETmontxt[ 8]=10
        SETmontxt[ 9]=11
        SETmontxt[10]=12
        SETmontxt[11]=01
        SETmontxt[12]=02

#-----------------
#----------------- STEP 1: izracunati sezonski srednjak za svaku godinu i svaki model odvojeno
#-----------------

    for MOD in $(seq 1 ${NMODS}) ; do
        INPUT=../DATA_CRU/${VAR}_CRU/${FILE[${MOD}]}
        OUTPUT=running.nc
        cdo -r -f nc -b 32 -setday,15 -runmean,3 -seldate,1961-02-01,2000-12-31 ${INPUT} ${OUTPUT}
        for SES in {1..12} ; do
            INPUT=running.nc
            OUTPUT=${VAR}_MOD_${MOD}_SM_${SEAStxt[${SES}]}_SMS_2014.nc
            cdo -r -selmon,${SETmontxt[${SES}]}  ${INPUT} ${OUTPUT}
        done #SES
        rm running.nc
    done #MOD

#    for SES in {1..12}    ; do
#    if [ ${NMODS} == 15 ] ; then
#        cdo ensavg ${VAR}_MOD_1_SM_${SEAStxt[${SES}]}_SMS_2014.nc ${VAR}_MOD_2_SM_${SEAStxt[${SES}]}_SMS_2014.nc ${VAR}_MOD_3_SM_${SEAStxt[${SES}]}_SMS_2014.nc       ${VAR}_MOD_4_SM_${SEAStxt[${SES}]}_SMS_2014.nc ${VAR}_MOD_5_SM_${SEAStxt[${SES}]}_SMS_2014.nc ${VAR}_MOD_6_SM_${SEAStxt[${SES}]}_SMS_2014.nc       ${VAR}_MOD_7_SM_${SEAStxt[${SES}]}_SMS_2014.nc ${VAR}_MOD_8_SM_${SEAStxt[${SES}]}_SMS_2014.nc ${VAR}_MOD_9_SM_${SEAStxt[${SES}]}_SMS_2014.nc       ${VAR}_MOD_10_SM_${SEAStxt[${SES}]}_SMS_2014.nc ${VAR}_MOD_11_SM_${SEAStxt[${SES}]}_SMS_2014.nc ${VAR}_MOD_12_SM_${SEAStxt[${SES}]}_SMS_2014.nc       ${VAR}_MOD_13_SM_${SEAStxt[${SES}]}_SMS_2014.nc ${VAR}_MOD_14_SM_${SEAStxt[${SES}]}_SMS_2014.nc ${VAR}_MOD_15_SM_${SEAStxt[${SES}]}_SMS_2014.nc       ${VAR}_MOD_ENSAVG_SM_${SEAStxt[${SES}]}_SMS_2014.nc
#    fi
#    if [ ${NMODS} == 14 ] ; then
#        cdo ensavg ${VAR}_MOD_1_SM_${SEAStxt[${SES}]}_SMS_2014.nc ${VAR}_MOD_2_SM_${SEAStxt[${SES}]}_SMS_2014.nc ${VAR}_MOD_3_SM_${SEAStxt[${SES}]}_SMS_2014.nc       ${VAR}_MOD_4_SM_${SEAStxt[${SES}]}_SMS_2014.nc ${VAR}_MOD_5_SM_${SEAStxt[${SES}]}_SMS_2014.nc ${VAR}_MOD_6_SM_${SEAStxt[${SES}]}_SMS_2014.nc       ${VAR}_MOD_7_SM_${SEAStxt[${SES}]}_SMS_2014.nc ${VAR}_MOD_8_SM_${SEAStxt[${SES}]}_SMS_2014.nc ${VAR}_MOD_9_SM_${SEAStxt[${SES}]}_SMS_2014.nc       ${VAR}_MOD_10_SM_${SEAStxt[${SES}]}_SMS_2014.nc ${VAR}_MOD_11_SM_${SEAStxt[${SES}]}_SMS_2014.nc ${VAR}_MOD_12_SM_${SEAStxt[${SES}]}_SMS_2014.nc       ${VAR}_MOD_13_SM_${SEAStxt[${SES}]}_SMS_2014.nc ${VAR}_MOD_14_SM_${SEAStxt[${SES}]}_SMS_2014.nc ${VAR}_MOD_ENSAVG_SM_${SEAStxt[${SES}]}_SMS_2014.nc
#    fi
#    done #SES


#-----------------
#----------------- STEP 2: izracunati za svaku godinu odvojeno i sve modele skupa taj srednjak. Nakon toga, srednjak po svim godinama i svim modelima
#-----------------

for TIP in {1..36}                       ; do
    for SES in 1 2 3 4 5 6 7 8 9   11 12 ; do
#        INPUT=${VAR}_MOD_ENSAVG_SM_${SEAStxt[${SES}]}_SMS_2014.nc
#        OUTPUT1=${VAR}_MOD_ENSAVG_TIMAVG_SM_${SEAStxt[${SES}]}_SMS_2014.nc              #Ovdje je visegodisnji srednjak po SVIM     godinama
#        OUTPUT2=${VAR}_MOD_ENSAVG_TIMAVG_TIP${TIP}_SM_${SEAStxt[${SES}]}_SMS_2014.nc    #Ovdje je visegodisnji srednjak po ODBRANIM godinama
#
#        cdo timavg                               ${INPUT} ${OUTPUT1}
#        cdo timavg -selyear,${GODINE[${TIP}]}    ${INPUT} ${OUTPUT2}


        for MOD in $(seq 1 ${NMODS}) ; do
        INPUT=${VAR}_MOD_${MOD}_SM_${SEAStxt[${SES}]}_SMS_2014.nc
        OUTPUT1=${VAR}_MOD_${MOD}_TIMAVG_SM_${SEAStxt[${SES}]}_SMS_2014.nc              #Ovdje visegodisnji srednjak po SVIM     godinama svaki model
        OUTPUT2=${VAR}_MOD_${MOD}_TIMAVG_TIP${TIP}_SM_${SEAStxt[${SES}]}_SMS_2014.nc    #Ovdje visegodisnji srednjak po ODBRANIM godinama svaki model
        cdo timavg                               ${INPUT} ${OUTPUT1}
        cdo timavg -selyear,${GODINE[${TIP}]}    ${INPUT} ${OUTPUT2}
        done #od MOD

    done #od SES

    for SES in 10                        ; do
#        INPUT=${VAR}_MOD_ENSAVG_SM_${SEAStxt[${SES}]}_SMS_2014.nc
#        OUTPUT1=${VAR}_MOD_ENSAVG_TIMAVG_SM_${SEAStxt[${SES}]}_SMS_2014.nc              #Ovdje je visegodisnji srednjak po SVIM      godinama
#        OUTPUT2=${VAR}_MOD_ENSAVG_TIMAVG_TIP${TIP}_SM_${SEAStxt[${SES}]}_SMS_2014.nc    #Ovdje je visegodisnji srednjka po ODABRANIM godinama
#
#        cdo timavg                               ${INPUT} ${OUTPUT1}
#        cdo timavg -selyear,${GODINEm[${TIP}]}   ${INPUT} ${OUTPUT2}

        for MOD in $(seq 1 ${NMODS}) ; do
        INPUT=${VAR}_MOD_${MOD}_SM_${SEAStxt[${SES}]}_SMS_2014.nc
        OUTPUT1=${VAR}_MOD_${MOD}_TIMAVG_SM_${SEAStxt[${SES}]}_SMS_2014.nc              #Ovdje visegodisnji srednjak po SVIM     godinama svaki model
        OUTPUT2=${VAR}_MOD_${MOD}_TIMAVG_TIP${TIP}_SM_${SEAStxt[${SES}]}_SMS_2014.nc    #Ovdje visegodisnji srednjak po ODBRANIM godinama svaki model
        cdo timavg                                ${INPUT} ${OUTPUT1}
        cdo timavg -selyear,${GODINEm[${TIP}]}    ${INPUT} ${OUTPUT2}
        done #od MOD


    done #od SES
done #od TIP

#-----------------
#----------------- STEP 3: kompozit analiza za pojedini tip godina
#-----------------

for TIP in {1..36}                        ; do
   for SES in 1 2 3 4 5 6 7 8 9 10 11 12  ; do

#	INPUT1=${VAR}_MOD_ENSAVG_TIMAVG_TIP${TIP}_SM_${SEAStxt[${SES}]}_SMS_2014.nc
#	INPUT2=${VAR}_MOD_ENSAVG_TIMAVG_SM_${SEAStxt[${SES}]}_SMS_2014.nc
#	OUTPUT=${VAR}_MOD_ENSAVG_SM_${SEAStxt[${SES}]}_TIP${TIP}_anomaly_SMS_2014.nc  #Ovdje je razlika visegodisnjih srednjaka po SVIM i ODABRANIM godinama
#        cdo sub ${INPUT1} ${INPUT2} ${OUTPUT}

	for MOD in $(seq 1 ${NMODS}) ; do
	INPUT1=${VAR}_MOD_${MOD}_TIMAVG_TIP${TIP}_SM_${SEAStxt[${SES}]}_SMS_2014.nc
	INPUT2=${VAR}_MOD_${MOD}_TIMAVG_SM_${SEAStxt[${SES}]}_SMS_2014.nc
	OUTPUT=${VAR}_MOD_${MOD}_SM_${SEAStxt[${SES}]}_TIP${TIP}_anomaly_SMS_2014.nc  
        cdo sub ${INPUT1} ${INPUT2} ${OUTPUT}
        done #od MOD


    done #od SES
done #od TIP

#-----------------
#----------------- STEP 4: racuna spreada unutar RCM ensambla za svaku sezonu i grupu godina
#-----------------

#Komentiran spread


#for TIP in {1..36}                         ; do
#   for SES in 3 12                         ; do                                                      #Racunam spread samo za AMJ i JFM
#
#RUCNO for MOD in {1..14}                   ; do !!!! OVO TREBA STAVITI NA 15 ZA PRECIP 2014-09-26
#                                                !!!! Jesan ovdje 2014-11-21 ali treba osvjeziti onda i ostale materijale
#        for MOD in $(seq 1 ${NMODS})       ; do
#	        INPUT1=${VAR}_MOD_${MOD}_SM_${SEAStxt[${SES}]}_SMS_2014.nc                           #MODEL po MODEL za GODINU po GODINU u grupi
#		INPUT2=${VAR}_MOD_ENSAVG_TIMAVG_SM_${SEAStxt[${SES}]}_SMS_2014.nc                    #ENSEMBLE i TIME srednjak
#		OUTPUT=${VAR}_MOD_${MOD}_SM_${SEAStxt[${SES}]}_TIP${TIP}_anomalySquared_SMS_2014.nc  
#       	rm -rfv temp.nc
#		cdo selyear,${GODINE[${TIP}]}  ${INPUT1} temp.nc
#		cdo timavg -pow,2 -sub temp.nc ${INPUT2} ${OUTPUT}
#	        rm -rfv temp.nc
#        done #od MOD
#
#	rm  -rfv temp.nc
#	OUTPUT=${VAR}_MOD_ENSAVG_SM_${SEAStxt[${SES}]}_TIP${TIP}_spread_SMS_2014.nc
#	cdo ensavg ${VAR}_MOD_*_SM_${SEAStxt[${SES}]}_TIP${TIP}_anomalySquared_SMS_2014.nc  temp.nc 
#       cdo sqrt temp.nc ${OUTPUT}
#	rm -rfv temp.nc
#	rm -rfv ${VAR}_MOD_*_SM_${SEAStxt[${SES}]}_TIP${TIP}_anomalySquared_SMS_2014.nc
#
#   done #od SES
#done #od TIP

#-----------------
#----------------- STE5 5: racuna relative spreada unutar RCM ensambla za svaku sezonu i grupu godina
#-----------------
#
#for TIP in {1..36}                         ; do
#   for SES in 3 12                         ; do                                              #Racunam relative spread samo za AMJ i JFM
#
#RUCNO  for MOD in {1..14}                 ; do !!!! OVO TREBA STAVITI NA 15 ZA PRECIP 2014-09-26
#                                             #  !!!! Jesan ovdje 2014-11-21 ali treba osvjeziti onda i ostale materijale
#        for MOD in $(seq 1 ${NMODS})       ; do
#	        INPUT1=${VAR}_MOD_${MOD}_SM_${SEAStxt[${SES}]}_SMS_2014.nc                           #MODEL po MODEL za GODINU po GODINU u grupi
#		INPUT2=${VAR}_MOD_ENSAVG_TIMAVG_SM_${SEAStxt[${SES}]}_SMS_2014.nc                    #ENSEMBLE i TIME srednjak
#		OUTPUT=${VAR}_MOD_${MOD}_SM_${SEAStxt[${SES}]}_TIP${TIP}_anomalySquared_SMS_2014.nc  
#        	rm -rfv temp.nc temp2.nc
#		cdo selyear,${GODINE[${TIP}]}   ${INPUT1}  temp.nc
#		cdo               -sub temp.nc  ${INPUT2}  temp2.nc
#		cdo timavg -pow,2 -div temp2.nc ${INPUT2} ${OUTPUT}
#	        rm -rfv temp.nc temp2.nc
#       done #od MOD
#
#	rm  -rfv temp.nc
#	OUTPUT=${VAR}_MOD_ENSAVG_SM_${SEAStxt[${SES}]}_TIP${TIP}_spreadRelative_SMS_2014.nc
#	cdo ensavg ${VAR}_MOD_*_SM_${SEAStxt[${SES}]}_TIP${TIP}_anomalySquared_SMS_2014.nc  temp.nc 
#       cdo sqrt temp.nc ${OUTPUT}
#	rm -rfv temp.nc
#	rm -rfv ${VAR}_MOD_*_SM_${SEAStxt[${SES}]}_TIP${TIP}_anomalySquared_SMS_2014.nc
#
#    done #od SES
#done #od TIP


done #od VAR
